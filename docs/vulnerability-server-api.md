# Vulnerability Server API Documentation

**Server**: VulnerabilityAgent
**Version**: 1.0.0
**Protocol**: FastMCP
**Port**: 5003 (default)

## ⚠️ Legal Notice

**AUTHORIZED USE ONLY**: These vulnerability assessment tools must only be used on systems you own or have explicit written permission to test. Unauthorized use may violate computer fraud and abuse laws.

---

## Table of Contents

1. [Overview](#overview)
2. [Tools](#tools)
   - [sqlmap_scan](#sqlmap_scan)
   - [nuclei_scan](#nuclei_scan)
   - [searchsploit_query](#searchsploit_query)
   - [metasploit_search](#metasploit_search)
   - [health_check](#health_check)
3. [Security](#security)
4. [Error Handling](#error-handling)
5. [Usage Examples](#usage-examples)

---

## Overview

The Vulnerability Server provides automated vulnerability assessment capabilities through integration with industry-standard security tools. All tools are exposed as asynchronous MCP tools with comprehensive input validation and security controls.

### Supported Tools

- **SQLMap** - SQL injection testing and database extraction
- **Nuclei** - Fast vulnerability scanner with template-based detection
- **SearchSploit** - Offline exploit database search
- **Metasploit** - Exploit framework module search

---

## Tools

### sqlmap_scan

Perform SQL injection testing using SQLMap.

#### Function Signature

```python
async def sqlmap_scan(
    target: str,
    data: Optional[str] = None,
    cookie: Optional[str] = None,
    level: int = 1,
    risk: int = 1,
    batch: bool = True,
    ctx: Optional[Context] = None
) -> Dict[str, Any]
```

#### Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `target` | str | Yes | - | Target URL to test (must start with http:// or https://) |
| `data` | str | No | None | POST data for form-based injection (e.g., "username=admin&password=test") |
| `cookie` | str | No | None | Cookie values to use in requests |
| `level` | int | No | 1 | Detection level (1-5, higher = more thorough) |
| `risk` | int | No | 1 | Risk level (1-3, higher = more invasive tests) |
| `batch` | bool | No | True | Run in batch mode (no user interaction) |
| `ctx` | Context | No | None | FastMCP context for logging |

#### Returns

```json
{
  "status": "completed|vulnerable|no_vulnerabilities|timeout|failed",
  "target": "http://example.com/page.php?id=1",
  "level": 1,
  "risk": 1,
  "vulnerabilities": [
    {
      "type": "SQL Injection",
      "severity": "critical",
      "description": "SQL injection vulnerability detected",
      "injection_points": [
        {
          "parameter": "id",
          "type": "boolean-based blind",
          "title": "AND boolean-based blind - WHERE or HAVING clause",
          "payload": "1 AND 1234=1234"
        }
      ]
    }
  ],
  "database_info": {
    "dbms": "MySQL >= 5.0"
  },
  "injection_points": [...],
  "command_used": "sqlmap -u http://example.com ..."
}
```

#### Security Features

- **URL Validation**: Rejects non-HTTP/HTTPS URLs
- **Parameter Validation**: Level (1-5) and risk (1-3) bounds checked
- **Command Injection Prevention**: No shell=True, array-based arguments
- **Timeout Protection**: 10-minute timeout to prevent DoS

#### Example Usage

```python
from mcp_client import MCPClient

client = MCPClient("vulnerability-server")

# Basic SQL injection test
result = await client.call_tool("sqlmap_scan", {
    "target": "http://example.com/page.php?id=1",
    "level": 2,
    "risk": 2
})

# POST data injection test
result = await client.call_tool("sqlmap_scan", {
    "target": "http://example.com/login.php",
    "data": "username=admin&password=test",
    "level": 3,
    "risk": 2
})

# With authentication
result = await client.call_tool("sqlmap_scan", {
    "target": "http://example.com/admin/users.php?id=1",
    "cookie": "session=abc123def456",
    "level": 4,
    "risk": 3
})
```

---

### nuclei_scan

Perform fast vulnerability scanning using Nuclei templates.

#### Function Signature

```python
async def nuclei_scan(
    target: str,
    templates: Optional[List[str]] = None,
    severity: Optional[List[str]] = None,
    tags: Optional[List[str]] = None,
    ctx: Optional[Context] = None
) -> Dict[str, Any]
```

#### Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `target` | str | Yes | - | Target URL or IP to scan |
| `templates` | List[str] | No | None | Specific template paths (e.g., ["cves/2021/", "vulnerabilities/"]) |
| `severity` | List[str] | No | None | Filter by severity: critical, high, medium, low, info |
| `tags` | List[str] | No | None | Filter by tags (e.g., ["rce", "sqli", "xss"]) |
| `ctx` | Context | No | None | FastMCP context for logging |

#### Returns

```json
{
  "status": "completed|timeout|failed",
  "target": "https://example.com",
  "filters": {
    "templates": ["cves/2021/"],
    "severity": ["critical", "high"],
    "tags": ["rce"]
  },
  "vulnerabilities": [
    {
      "template_id": "CVE-2021-41773",
      "name": "Apache HTTP Server 2.4.49 - Path Traversal and RCE",
      "severity": "critical",
      "type": "http",
      "host": "https://example.com",
      "matched_at": "https://example.com/cgi-bin/.%2e/.%2e/.%2e/.%2e/etc/passwd",
      "description": "Apache HTTP Server versions 2.4.49 and 2.4.50...",
      "reference": ["https://nvd.nist.gov/vuln/detail/CVE-2021-41773"],
      "tags": ["cve", "apache", "rce", "lfi"]
    }
  ]
}
```

#### Example Usage

```python
# Scan for critical CVEs
result = await client.call_tool("nuclei_scan", {
    "target": "https://example.com",
    "templates": ["cves/2021/", "cves/2022/"],
    "severity": ["critical", "high"]
})

# Scan for specific vulnerability types
result = await client.call_tool("nuclei_scan", {
    "target": "https://example.com",
    "tags": ["rce", "sqli", "xss"]
})

# Full scan with all templates
result = await client.call_tool("nuclei_scan", {
    "target": "https://example.com"
})
```

---

### searchsploit_query

Search the Exploit Database using SearchSploit.

#### Function Signature

```python
async def searchsploit_query(
    query: str,
    exact: bool = False,
    json_output: bool = True,
    ctx: Optional[Context] = None
) -> Dict[str, Any]
```

#### Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `query` | str | Yes | - | Search query (e.g., "wordpress 5.0", "apache 2.4") |
| `exact` | bool | No | False | Use exact match instead of fuzzy search |
| `json_output` | bool | No | True | Return results in JSON format |
| `ctx` | Context | No | None | FastMCP context for logging |

#### Returns

```json
{
  "status": "completed|timeout|failed",
  "query": "wordpress 5.0",
  "total_results": 5,
  "exploits": [
    {
      "title": "WordPress 5.0.0 - Image Remote Code Execution",
      "path": "/usr/share/exploitdb/exploits/php/webapps/49512.py",
      "date": "2020-11-13",
      "author": "Vince Warrington",
      "type": "webapps",
      "platform": "php"
    }
  ]
}
```

#### Security Features

- **Input Validation**: Rejects special characters (; | & ` $ ( ))
- **Command Injection Prevention**: Array-based subprocess calls
- **Timeout**: 30-second timeout

#### Example Usage

```python
# Search for WordPress exploits
result = await client.call_tool("searchsploit_query", {
    "query": "wordpress 5.0"
})

# Exact match search
result = await client.call_tool("searchsploit_query", {
    "query": "Apache HTTP Server 2.4.49",
    "exact": True
})

# Search for specific platform
result = await client.call_tool("searchsploit_query", {
    "query": "linux kernel 5.4"
})
```

---

### metasploit_search

Search Metasploit Framework modules.

#### Function Signature

```python
async def metasploit_search(
    keyword: str,
    search_type: str = "all",
    ctx: Optional[Context] = None
) -> Dict[str, Any]
```

#### Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `keyword` | str | Yes | - | Search keyword (e.g., "wordpress", "apache") |
| `search_type` | str | No | "all" | Module type: exploit, auxiliary, payload, encoder, nop, post, all |
| `ctx` | Context | No | None | FastMCP context for logging |

#### Returns

```json
{
  "status": "completed|timeout|failed",
  "keyword": "wordpress",
  "search_type": "exploit",
  "total_results": 12,
  "modules": [
    {
      "name": "exploit/unix/webapp/wordpress_admin_shell_upload",
      "disclosure_date": "2015-02-21",
      "rank": "excellent",
      "description": "WordPress Admin Shell Upload"
    }
  ]
}
```

#### Security Features

- **Type Validation**: search_type must be in allowed list
- **Input Validation**: Rejects special characters
- **Timeout**: 60-second timeout

#### Example Usage

```python
# Search for WordPress exploits
result = await client.call_tool("metasploit_search", {
    "keyword": "wordpress",
    "search_type": "exploit"
})

# Search all module types
result = await client.call_tool("metasploit_search", {
    "keyword": "apache",
    "search_type": "all"
})

# Search for auxiliary modules
result = await client.call_tool("metasploit_search", {
    "keyword": "scanner",
    "search_type": "auxiliary"
})
```

---

### health_check

Check server health and tool availability.

#### Function Signature

```python
async def health_check(ctx: Optional[Context] = None) -> Dict[str, Any]
```

#### Returns

```json
{
  "status": "healthy|degraded",
  "tools": {
    "sqlmap": true,
    "searchsploit": true,
    "nuclei": false,
    "metasploit": true
  },
  "server": "VulnerabilityAgent",
  "version": "1.0.0"
}
```

#### Example Usage

```python
# Check if all tools are available
result = await client.call_tool("health_check", {})

if result["status"] == "healthy":
    print("All tools available!")
else:
    print(f"Missing tools: {[k for k, v in result['tools'].items() if not v]}")
```

---

## Security

### Input Validation

All tools implement comprehensive input validation:

- **URL Validation**: SQLMap and Nuclei validate URL format (must start with http:// or https://)
- **Parameter Bounds**: Level (1-5), Risk (1-3) enforced
- **Character Filtering**: Special characters rejected from search queries
- **Type Validation**: search_type, severity, tags validated against whitelists

### Command Injection Prevention

**NEVER uses `shell=True`** in subprocess calls. All commands are built as arrays:

```python
# SECURE (what we do)
subprocess.run(["sqlmap", "-u", target])

# INSECURE (what we DON'T do)
subprocess.run(f"sqlmap -u {target}", shell=True)  # NEVER!
```

### Timeout Protection

All tools have timeouts to prevent denial of service:

- SQLMap: 10 minutes (600s)
- Nuclei: 5 minutes (300s)
- SearchSploit: 30 seconds
- Metasploit Search: 60 seconds

### Error Handling

- Graceful degradation on tool failures
- No sensitive information in error messages
- Proper exception handling for all subprocess calls
- Timeout exceptions handled separately

---

## Error Handling

### Common Errors

#### Tool Not Found

```json
{
  "status": "failed",
  "error": "nuclei not found. Install with: go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest",
  "target": "https://example.com"
}
```

#### Invalid Input

```json
{
  "status": "failed",
  "error": "Invalid URL: must start with http:// or https://",
  "target": "ftp://example.com"
}
```

#### Timeout

```json
{
  "status": "timeout",
  "error": "Scan exceeded timeout limit",
  "target": "https://example.com"
}
```

#### Command Injection Attempt

```json
{
  "status": "failed",
  "error": "Invalid query: contains potentially malicious characters",
  "query": "wordpress; rm -rf /"
}
```

---

## Usage Examples

### Python Client

```python
import asyncio
from mcp_client import MCPClient

async def vulnerability_assessment(target):
    client = MCPClient("vulnerability-server")

    # 1. Check server health
    health = await client.call_tool("health_check", {})
    if health["status"] != "healthy":
        print(f"Warning: Some tools unavailable: {health['tools']}")

    # 2. Search for known exploits
    software = "Apache HTTP Server 2.4.49"
    exploits = await client.call_tool("searchsploit_query", {
        "query": software
    })
    print(f"Found {exploits['total_results']} exploits for {software}")

    # 3. Scan for vulnerabilities with Nuclei
    nuclei_results = await client.call_tool("nuclei_scan", {
        "target": target,
        "severity": ["critical", "high"],
        "tags": ["cve", "rce"]
    })
    print(f"Nuclei found {len(nuclei_results['vulnerabilities'])} critical/high issues")

    # 4. Test for SQL injection
    sqlmap_results = await client.call_tool("sqlmap_scan", {
        "target": f"{target}/page.php?id=1",
        "level": 2,
        "risk": 2
    })

    if sqlmap_results["status"] == "vulnerable":
        print(f"⚠️ SQL injection found in {len(sqlmap_results['injection_points'])} parameters!")

    # 5. Search Metasploit for relevant modules
    msf_results = await client.call_tool("metasploit_search", {
        "keyword": "apache",
        "search_type": "exploit"
    })
    print(f"Found {msf_results['total_results']} Metasploit modules")

    return {
        "exploits": exploits,
        "nuclei": nuclei_results,
        "sqlmap": sqlmap_results,
        "metasploit": msf_results
    }

# Run assessment
asyncio.run(vulnerability_assessment("https://example.com"))
```

### Curl Examples

```bash
# Health check
curl -X POST http://localhost:5003/tools/health_check \
  -H "Content-Type: application/json" \
  -d '{}'

# SQL injection scan
curl -X POST http://localhost:5003/tools/sqlmap_scan \
  -H "Content-Type: application/json" \
  -d '{
    "target": "http://example.com/page.php?id=1",
    "level": 2,
    "risk": 2
  }'

# SearchSploit query
curl -X POST http://localhost:5003/tools/searchsploit_query \
  -H "Content-Type: application/json" \
  -d '{
    "query": "wordpress 5.0"
  }'
```

---

## Installation

### Prerequisites

```bash
# Install required tools on Kali Linux
sudo apt-get update
sudo apt-get install -y sqlmap exploitdb metasploit-framework

# Install Nuclei
go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest
```

### Environment Variables

Create `.env` file:

```bash
# Server Configuration
VULN_SERVER_PORT=5003
MCP_TRANSPORT=http

# Tool Paths (optional - defaults shown)
SQLMAP_PATH=/usr/bin/sqlmap
SEARCHSPLOIT_PATH=/usr/bin/searchsploit
NUCLEI_PATH=/usr/bin/nuclei
MSFCONSOLE_PATH=/usr/bin/msfconsole

# Timeouts
DEFAULT_TIMEOUT=30
```

### Starting the Server

```bash
python -m src.mcp_servers.vulnerability_server
```

---

## Testing

Run the comprehensive test suite:

```bash
# All tests (62 tests, 96% coverage)
pytest tests/test_vulnerability_server.py -v

# Security tests only
pytest tests/test_vulnerability_server.py -m security -v

# With coverage report
pytest tests/test_vulnerability_server.py \
    --cov=src/mcp_servers/vulnerability_server \
    --cov-report=term-missing \
    --cov-report=html
```

---

## License & Legal

### License
GPL-3.0 - See LICENSE file

### Legal Disclaimer

⚠️ **IMPORTANT**: This server provides access to powerful security testing tools. Users are responsible for:

- Obtaining explicit written authorization before testing any systems
- Complying with all applicable laws (CFAA, Computer Misuse Act, etc.)
- Using tools only for authorized penetration testing and security research
- Not performing unauthorized access, data theft, or denial of service

**Unauthorized use may result in criminal prosecution.**

### Responsible Disclosure

If vulnerabilities are discovered:
1. Notify system owners immediately
2. Do not exploit beyond proof-of-concept
3. Allow reasonable time for remediation
4. Follow coordinated disclosure guidelines

---

## Support

- **Issues**: https://github.com/Huleinpylo/kali-agents-mcp/issues
- **Documentation**: https://huleinpylo.github.io/kali-agents-mcp
- **Security**: security@example.com

---

**Last Updated**: 2024-11-13
**Version**: 1.0.0
**Maintainer**: Kali Agents Development Team
